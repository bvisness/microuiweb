<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>WASM Test</title>
</head>

<body>
	<script type="module">
		async function init() {
			const mem = new WebAssembly.Memory({
				initial: 2,
			});

			function dumpMem8(mem) {
				console.log(new Uint8Array(mem.buffer));
			}

			function dumpMem32(mem) {
				console.log(new Uint32Array(mem.buffer));
			}

			const sysFetch = fetch("/sys.wasm");
			const mainFetch = fetch("/test.wasm");

			const { instance: sys } = await WebAssembly.instantiateStreaming(
				sysFetch,
				{
					env: {
						memory: mem,
					}
				}
			);

			dumpMem8(mem);
			sys.exports.memset(2, 256+123, 4);
			sys.exports.memset(6, 256+234, 4);
			dumpMem8(mem);
			sys.exports.memcpy(0, 4, 4);
			dumpMem8(mem);

			const { instance: test } = await WebAssembly.instantiateStreaming(
				mainFetch,
				{
					env: {
						memory: mem,
						...sys.exports,
						printInt: console.log,
						printLong: console.log,
						printDouble: console.log,
					},
				}
			);

			console.log('fib test');
			console.log(test.exports.fib(20));
			
			console.log('qsort test');
			test.exports.boo();
			
			console.log('strlen test');
			test.exports.goober();

			console.log('sprintf test');
			test.exports.foop(0);
			dumpMem8(mem);

			console.log('strtod test');
			test.exports.glamp();
		}
		init();
	</script>
</body>

</html>
