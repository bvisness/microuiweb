<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>WASM Test</title>
</head>

<body>
	<script type="module">
		async function init() {
			const mem = new WebAssembly.Memory({
				initial: 10,
			});

			function dumpMem8(mem) {
				console.log(new Uint8Array(mem.buffer));
			}

			function dumpMem32(mem) {
				console.log(new Uint32Array(mem.buffer));
			}

			function findNonZero(mem) {
				let currentSection = [];
				const buf = new Uint8Array(mem.buffer)

				for (let i = 0; i < buf.length; i++) {
					const v = buf[i];
					if (v) {
						currentSection.push(v);
					} else {
						if (currentSection.length) {
							console.log(i, currentSection);
							currentSection = [];
						}
					}
				}

				if (currentSection.length) {
					console.log(currentSection);
				}
			}

			function getString(ptr) {
				const codes = [];
				const buf = new Uint8Array(mem.buffer);

				while (true) {
					const char = buf[ptr];
					if (!char) {
						break;
					} else {
						codes.push(char);
						ptr++;
					}
				}

				return String.fromCharCode(...codes);
			}

			const sysFetch = fetch("/sys.wasm");
			const mainFetch = fetch("/test.wasm");

			const { instance: sys } = await WebAssembly.instantiateStreaming(
				sysFetch,
				{
					env: {
						memory: mem,
					}
				}
			);

			const { instance: test } = await WebAssembly.instantiateStreaming(
				mainFetch,
				{
					env: {
						memory: mem,
						...sys.exports,
						printInt: console.log,
						printLong: console.log,
						printDouble: console.log,
						printString: ptr => console.log(getString(ptr)),
					},
				}
			);

			test.exports.init();
			test.exports.frame();

			// function doFrame() {
			// 	test.exports.frame();
			// 	window.requestAnimationFrame(doFrame);
			// }
			// window.requestAnimationFrame(doFrame);
		}
		init();
	</script>
</body>

</html>
